# 数据探索 API

## 概述

在数据探索功能中，用户可以选择结果工作流嵌入节点处理后的文件或者是 MOI table 类型的表，对这些数据进行 RAG 或 nl2sql 的查询。

nl2sql 下有一层语义层的配置，本文档将详细介绍 MOI 语义层配置教程。

## MOI 语义层配置教程

### 1. 概述

MOI 的语义层（Semantic Layer）是连接业务用户自然语言与底层数据结构的关键桥梁。它的核心作用是将复杂的数据库 Schema（表结构、字段名）映射为业务人员可理解的术语和逻辑，从而让大模型能够准确地将用户的自然语言问题转化为正确的 SQL 查询或分析操作。

MOI 的语义层配置主要包含以下四个核心模块：

### 2. 核心配置模块详解

#### 2.1 同义词解释

**功能定义：**

同义词解释用于解决数据表中的物理字段名与用户日常口语习惯不一致的问题。通过配置同义词，可以扩大模型对字段的识别范围，提高召回率。

**主要用途：**

- **字段别名映射：**数据库中字段可能叫 `cust_id` 或 `c_name`，业务人员只会说 "客户"、"客户名"、"买家"。
- **缩写与行话匹配：**识别业务特有的缩写（如 "GMV" 对应 "交易总额" 字段）。
- **消除歧义：**当用户说法模糊时，明确指代某个具体字段。

**配置示例：**

| 数据表字段 | 字段名 | 配置同义词 |
|-----------|--------|-----------|
| order_amt | 订单金额 | 销售额、成交额、收入、流水 |
| region | 地区 | 区域、省份、地盘 |

#### 2.2 知识名词解释

**功能定义：**

知识名词解释主要用于定义业务专有名词，特别是那些在原始数据表中不存在实体列，需要通过计算或特定逻辑推导出来的指标（Derived Metrics）。

**主要用途：**

- **定义计算口径：**告诉模型某个特定名词是如何计算出来的。
- **业务术语解释：**对于模型预训练知识库中不存在的行业黑话进行定义。

**配置示例与逻辑：**

- **场景：**用户问 "上个月的咨询转化率是多少？"（数据库中没有 "咨询转化率" 这一列）。
- **配置内容：**
  - 名词：咨询转化率
  - 描述/公式：指标计算方式为：SUM (下单成功客户数) / SUM (咨询客户总数)。
- **效果：**模型在遇到 "咨询转化率" 时，会自动生成包含除法运算的 SQL 语句，而不是去查找不存在的字段。

#### 2.3 业务逻辑解释

**功能定义：**

这是语义层中最高级的配置，用于向模型灌输企业特有的、非通俗的逻辑规则。它不仅限于名词解释，更包含条件限定、默认规则和复杂的运算逻辑。

**主要用途：**

- **设置默认条件（全局逻辑）：**例如，企业定义 "有效订单" 必须是 "状态为已完成且未退款" 的订单。
- **纠正模型偏差：**当模型倾向于错误的默认行为时，通过显式逻辑进行纠正。
- **复杂 SQL 片段注入：**直接提供 SQL 片段作为逻辑解释。

**配置类型：**

1. **全局生效 (Global)：**适用于绝大多数查询场景。例如："所有涉及金额的计算，默认单位都是 '万元'"。
2. **智能判断 (Smart Selection)：**模型根据用户问题的内容，自动判断是否需要应用该逻辑。

**配置建议（优化技巧）：**

- **Less is More：**业务逻辑并非越多越好，过多的逻辑可能导致模型混淆。建议精简配置。
- **形式化描述：**建议以数学公式或 SQL 片段的形式给出解释，而非纯大白话，这样模型的执行准确率更高。
  - ❌ Bad: "算利润的时候把成本去掉。"
  - ✅ Good: 利润 = 销售收入 - 营销成本 - 人力成本

#### 2.4 优化案例

**功能定义：**

优化案例（部分版本称为 "问答修正" 或 "案例管理"）是一种基于示例的学习机制（Few-Shot Learning）。当上述三种配置（同义词、名词、逻辑）都无法让模型输出正确结果时，人工直接提供 "问题 - 标准答案" 对，强制指导模型学习。

**主要用途：**

- **解决 Corner Case（长尾难题）：**针对模型反复理解错误的特定复杂问题。
- **人工干预/兜底：**作为最后一道防线，确保高频核心问题的准确性。
- **意图纠正：**当模型完全误解用户意图时（例如将 "查看明细" 误理解为 "统计总数"）。

**配置结构：**

通常包含两个部分：

1. **用户问题 (User Query)：**"在这个月销售额超过 100 万的店铺中，找出复购率最高的前三名。"
2. **期望的 SQL/处理逻辑 (Expected SQL/Logic)：**提供一段经过验证的、完全正确的 SQL 语句。

**工作原理：**

当用户提出类似问题时，系统会利用向量检索技术（RAG）召回相似的 "优化案例"，并将这些案例作为 Prompt 的一部分输入给大模型，模型会模仿案例的逻辑来生成新的答案。

### 3. 语义层配置总结

| 配置模块 | 核心作用 | 适用场景 | 关键点 |
|---------|---------|---------|--------|
| 同义词解释 | 找对列 | 别名、缩写、口语化表达 | 增加字段识别率 |
| 知识名词解释 | 算对数 | 衍生指标、计算公式、专有名词 | 定义计算口径 (A/B) |
| 业务逻辑解释 | 走对路 | 默认过滤条件、全局规则、特殊逻辑 | 建议用公式/SQL 表达 |
| 优化案例 | 教对题 | 复杂嵌套查询、模型反复出错的难题 | 提供标准 SQL 作为范例 |

通过这四层配置的组合，企业可以将原本只有技术人员懂的数据库结构，转化为全员可用的自然语言查询能力。
